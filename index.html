<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√öltimo Nivel</title>

  <style>
    :root{
      --ink:#e7fff4;
      --muted:#b7d9c9;
      --line:#0e2f25;
      --accent:#31c48d;
      --accent2:#6ef2c1;
      --warn:#ffb3b3;
      --card: rgba(255,255,255,.04);
      --red:#ff4d6d;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0; min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      display:flex; align-items:center; justify-content:center;
      padding:24px;
      overflow:hidden;
      background:#030a07;
    }

    /* Background video */
    #bgvideo{
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      min-width:100%;
      min-height:100%;
      width:auto; height:auto;
      z-index:-3;
      object-fit:cover;
      filter: blur(2px) brightness(.50) contrast(1.12);
      opacity:.20;
    }

    .overlay{
      position:fixed; inset:0;
      z-index:-2;
      background: radial-gradient(1200px 700px at 50% 35%,
        rgba(10,42,31,.55) 0%,
        rgba(6,17,13,.86) 55%,
        rgba(3,10,7,.93) 100%);
    }

    /* Confetti */
    #confetti{
      position:fixed; inset:0;
      z-index:5;
      pointer-events:none;
      display:none;
    }

    /* Card */
    .card{
      width:min(860px,100%);
      background: var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      padding:18px 18px 20px;
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 210px at 18% 10%, rgba(49,196,141,.18), transparent 60%),
        radial-gradient(640px 260px at 86% 12%, rgba(110,242,193,.14), transparent 62%),
        radial-gradient(700px 320px at 50% 102%, rgba(49,196,141,.10), transparent 60%);
      filter: blur(10px);
      opacity:.85;
      pointer-events:none;
      z-index:0;
    }
    .inner{ position:relative; z-index:1; }

    /* HUD (top) */
    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; letter-spacing:.15em; text-transform:uppercase;
      color:var(--muted);
      gap:12px;
      margin-bottom:12px;
    }
    .leftpack{ display:flex; align-items:center; gap:10px; min-width:190px; }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 18px rgba(49,196,141,.55);
      display:inline-block;
    }

    .hud{
      display:flex; align-items:center; gap:12px;
      justify-content:flex-end;
      flex:1;
    }

    .checkpoints{ display:flex; gap:6px; align-items:center; }
    .cp{
      width:10px;height:10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      transition: transform .2s ease, background .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .cp.key{ width:12px;height:12px; }
    .cp.on{
      background: rgba(49,196,141,.55);
      border-color: rgba(49,196,141,.55);
      box-shadow:0 0 16px rgba(49,196,141,.35);
      transform: translateY(-1px);
    }

    /* Content */
    h1{ margin:0 0 10px; font-size:22px; letter-spacing:.2px; text-align:center; }
    p{ margin:10px 0; line-height:1.62; text-align:center; }
    .muted{ color:var(--muted); font-size:14px; }
    .divider{ height:1px; background: var(--line); margin:14px 0; }
    .big{ font-size:18px; }
    .ok{ color:#7CFCB2; font-weight:800; }
    .no{ color:var(--warn); font-weight:800; }

    .btns{ display:grid; gap:10px; margin-top:18px; }
    button{
      border:1px solid var(--line);
      background: rgba(49,196,141,.15);
      color:var(--ink);
      padding:14px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, box-shadow .2s ease;
    }
    button:hover{
      background: rgba(49,196,141,.25);
      box-shadow:0 0 18px rgba(49,196,141,.08);
    }
    button:active{ transform: translateY(1px); }
    button.secondary{ background: transparent; color:var(--muted); }
    button.secondary:hover{ background: rgba(255,255,255,.03); color:var(--ink); }

    .input{
      width:100%; padding:12px; margin-top:12px;
      border-radius:12px; border:1px solid var(--line);
      background: rgba(0,0,0,.20); color:var(--ink);
      outline:none;
      font-size:16px;
      text-align:center;
    }
    .hint{ margin-top:10px; font-size:13px; color:var(--muted); text-align:center; }

    .swap{ animation: swapIn .28s ease both; }
    @keyframes swapIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* Error screen */
    .errorBox{
      border:1px solid rgba(255,179,179,.35);
      background: rgba(255,179,179,.06);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 0 22px rgba(255,179,179,.08);
      text-align:center;
    }
    .errorTitle{
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      margin:0 0 6px;
      color:var(--warn);
      text-align:center;
    }
    .small{ font-size:13px; color:var(--muted); text-align:center; }

    /* =======================
       PROGRESS DOCK (bottom, centered)
    ======================= */
    .progressDock{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin: 14px 0 6px;
      user-select:none;
    }

    .barwrap{
      width:min(520px, 72%);
      height:10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      transition: opacity .25s ease;
    }
    .barfill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(49,196,141,.35), rgba(110,242,193,.55));
      box-shadow:0 0 18px rgba(49,196,141,.35);
      border-radius:999px;
      transition: width .35s ease;
    }

    /* smaller hearts that "approach" */
    .pHeart{
      width:16px;
      height:16px;
      position:relative;
      transform: rotate(-45deg);
      border-radius:4px;
      transition: transform .45s ease, filter .45s ease, opacity .25s ease;
      filter: drop-shadow(0 0 10px rgba(49,196,141,.16));
      opacity: .95;
      flex: 0 0 auto;
    }
    .pHeart::before,
    .pHeart::after{
      content:"";
      position:absolute;
      width:16px;
      height:16px;
      border-radius:50%;
      background: inherit;
    }
    .pHeart::before{ top:-8px; left:0; }
    .pHeart::after{ left:8px; top:0; }

    .pHeart.green{ background: rgba(49,196,141,.92); }
    .pHeart.red{ background: rgba(255,77,109,.95); filter: drop-shadow(0 0 12px rgba(255,77,109,.22)); }

    .pHeart.final{
      display:none;
      transform: rotate(-45deg) scale(1.08);
      animation: finalPop .55s ease both;
    }
    @keyframes finalPop{
      0%{ transform: rotate(-45deg) scale(.75); opacity:.2; }
      55%{ transform: rotate(-45deg) scale(1.15); opacity:1; }
      100%{ transform: rotate(-45deg) scale(1.00); opacity:1; }
    }

    /* =======================
       INTRO OVERLAY (heart only + enter)
    ======================= */
    #introScreen{
      position:fixed; inset:0;
      z-index:9999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background: radial-gradient(900px 600px at 50% 35%,
        rgba(49,196,141,.12) 0%,
        rgba(6,17,13,.88) 55%,
        rgba(3,10,7,.95) 100%);
      backdrop-filter: blur(6px);
    }

    .introCard{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius:22px;
      background: rgba(255,255,255,.035);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      padding:28px 22px 22px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }

    .introCard::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 210px at 18% 10%, rgba(49,196,141,.18), transparent 60%),
        radial-gradient(640px 260px at 86% 12%, rgba(110,242,193,.14), transparent 62%),
        radial-gradient(700px 320px at 50% 102%, rgba(49,196,141,.10), transparent 60%);
      filter: blur(10px);
      opacity:.85;
      pointer-events:none;
    }

    .introInner{ position:relative; z-index:1; }

    .heartWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 6px 0 18px;
    }

    .heart{
      width:92px;
      height:92px;
      position:relative;
      transform: rotate(-45deg);
      background: rgba(49,196,141,.95);
      box-shadow: 0 0 28px rgba(49,196,141,.22), 0 0 70px rgba(49,196,141,.10);
      animation: heartbeat 1.05s ease-in-out infinite;
      border-radius:16px;
    }

    .heart::before,
    .heart::after{
      content:"";
      position:absolute;
      width:92px;
      height:92px;
      background: rgba(49,196,141,.95);
      border-radius:50%;
    }

    .heart::before{ top:-46px; left:0; }
    .heart::after{ left:46px; top:0; }

    @keyframes heartbeat{
      0%   { transform: rotate(-45deg) scale(1);   filter: brightness(1); }
      18%  { transform: rotate(-45deg) scale(1.10); filter: brightness(1.08); }
      34%  { transform: rotate(-45deg) scale(1.00); }
      52%  { transform: rotate(-45deg) scale(1.08); filter: brightness(1.06); }
      70%  { transform: rotate(-45deg) scale(1.00); }
      100% { transform: rotate(-45deg) scale(1); }
    }

    #introStart{
      width:100%;
      margin-top: 6px;
    }
  </style>
</head>

<body>

  <video id="bgvideo" autoplay muted loop playsinline preload="auto">
    <source src="video.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <!-- üíö Intro Screen (heart + Enter only) -->
  <div id="introScreen" aria-label="Intro">
    <div class="introCard">
      <div class="introInner">
        <div class="heartWrap">
          <div class="heart" aria-hidden="true"></div>
        </div>
        <button id="introStart">Enter</button>
      </div>
    </div>
  </div>

  <canvas id="confetti"></canvas>

  <audio id="bgm" loop preload="auto">
    <source src="music.mp3" type="audio/mpeg">
  </audio>

  <div class="card" role="application" aria-label="√öltimo Nivel">
    <div class="inner">
      <div class="topbar">
        <div class="leftpack">
          <span class="dot"></span>
          <span id="tag">inicio</span>
        </div>

        <div class="hud">
          <div class="checkpoints" id="checkpoints"></div>
          <!-- XP REMOVED -->
        </div>
      </div>

      <h1 id="title">Cargando‚Ä¶</h1>
      <div id="content"></div>

      <!-- ‚úÖ Progress centered under the questionnaire -->
      <div class="progressDock" aria-label="Progreso">
        <div class="pHeart green" id="pHeartL" aria-hidden="true"></div>
        <div class="barwrap" id="barwrap"><div class="barfill" id="barfill"></div></div>
        <div class="pHeart green" id="pHeartR" aria-hidden="true"></div>
        <div class="pHeart red final" id="pHeartFinal" aria-hidden="true"></div>
      </div>

      <div class="btns" id="btns"></div>
    </div>
  </div>

<script>
/* =======================
   CONFIG
======================= */
const NAME = "Mayra";

/* =======================
   MUSIC (fade-in)
======================= */
const bgm = document.getElementById("bgm");
let musicStarted = false;
function startMusic(){
  if (musicStarted) return;
  musicStarted = true;
  bgm.volume = 0;
  bgm.play().catch(()=>{});
  let v = 0;
  const fade = setInterval(()=>{
    v += 0.02;
    bgm.volume = Math.min(v, 0.26);
    if (v >= 0.26) clearInterval(fade);
  }, 120);
}

/* =======================
   HELPERS
======================= */
let step = 0;

function el(id){ return document.getElementById(id); }
function normalize(s){
  return (s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^\w\s\/\.\-]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

/* =======================
   FLOW (STEPS)
======================= */
const steps = [
  {
    tag:"inicio",
    title:`Hola, ${NAME}. üíö`,
    html:`
      <p class="muted">Ok‚Ä¶ esto es algo chiquito, pero lo hice con mucho amor.</p>
      <p>Examen extraordinario. Sin presi√≥n üíö.</p>
      <div class="divider"></div>
      <p class="muted">Reglas:</p>
      <p class="muted">1) No te saltes nada.<br>2) Si sonr√≠es, vas bien.<br>3) Si te pones nerviosa‚Ä¶ yo tambi√©n üòå</p>
    `,
    buttons:[{ text:"Empezar", action:()=>{ startMusic(); go(1); } }]
  },

  {
    tag:"pregunta 1/6",
    title:"Level 1 ‚Äî Se√±al clar√≠sima üòè",
    html:`
      <p>Prestamos atencion?</p>
      <p class="big"><b>¬øCu√°l es la se√±al m√°s obvia de que me gustas?</b></p>
      <p class="muted">Piensale bien.</p>
    `,
    buttons:[
      { text:"Me pierdo en tu mirada", action:()=>go(2) },
      { text:"Me dan ganas de verte aunque est√© cansado", action:()=>go(2) },
      { text:"Contigo siento mucha paz", action:()=>go(2) }
    ]
  },

  {
    tag:"pregunta 2/6",
    title:"Level 2 ‚Äî Mayra? Daniel? üß†",
    html:`
      <p class="muted">Sera?</p>
      <p class="big"><b>Que vez en nosotros?</b></p>
      <p>Elige la opci√≥n que te diga tu kokoro:</p>
    `,
    buttons:[
      { text:"Nuevos compa√±eros de baile! ", action:()=>go(3) },
      { text:"Algo no planeado pero que quiero seguir ", action:()=>go(3) },
      { text:"Una tranquilidad perfecta", action:()=>go(3) },
      { text:"No mucho la verdad üòè", action:()=>go(3) }
    ]
  },

  {
    tag:"pregunta 3/6",
    title:"Level 3 ‚Äî Completa la frase",
    html:`
      <p>Quiero una respuesta tuya, no hay opci√≥n m√∫ltiple üòå</p>
      <p class="big"><b>Completa:</b> ‚ÄúMe tienes: ______.‚Äù</p>
      <p class="muted">Una o dos palabras. Lo primero que te salga.</p>
      <input id="a3" class="input" placeholder="Escr√≠belo aqu√≠‚Ä¶" autocomplete="off">
      <div id="fb3" class="hint">Tip: puede ser ‚Äúharta‚Äù, ‚Äúfeliz‚Äù, ‚Äúcansada‚Äù, ‚Äúüíö‚Äù‚Ä¶</div>
    `,
    buttons:[
      { text:"Continuar", action:()=>{
          const v = normalize(el("a3").value);
          if(v.length >= 2) go(4);
          else el("fb3").innerHTML = `<span class="no">Come on, pon algo üòå</span>`;
        }
      },
      { text:"Dame idea", secondary:true, action:()=>{
          el("a3").value = "hasta la madre";
          el("fb3").innerHTML = `<span class="ok">Si.</span> ?.`;
        }
      }
    ]
  },

  {
    tag:"pregunta 4/6",
    title:"Level 4 ‚Äî Desde cuando Mayra? üíö",
    html:`
      <p class="muted">A ver dime.</p>
      <p class="big"><b>¬øDesde cuando nos viste futuro?</b></p>
      <p>Elige:</p>
    `,
    buttons:[
      { text:"De que hablas loco?", action:()=>go(5) },
      { text:"Since our first date", action:()=>go(5) },
      { text:"*Te lo dire con palabras*", action:()=>go(5) }
    ]
  },

  {
    tag:"pregunta 5/6",
    title:"Level 5 ‚Äî Race Day?üòè",
    html:`
      <p class="muted">Si te r√≠es aqu√≠, ya ganamos.</p>
      <p class="big"><b>Que medio marat√≥n cambio todo?</b></p>
      <p class="muted">Pi√©nsalo bien.</p>
    `,
    buttons:[
      { text:"Medio Marat√≥n Tijuana 2023", action:()=>go(6) },
      { text:"Medio Marat√≥n UABC 2025", action:()=>go(6) },
      { text:"Medio Marat√≥n SatBoyz 2026", action:()=>go(6) }
    ]
  },

  {
    tag:"pregunta 6/6",
    title:"Level 6 ‚Äî The last one",
    html:`
      <p>√öltima pregunta??.</p>
      <p class="big"><b>¬øComo se llama el cuadernito que dejamos en el carro?</b></p>
      <p class="muted">El nombre es importante.</p>
    `,
    buttons:[
      { text:"Sky Journal", action:()=>go(7) },
      { text:"Star Notebook", action:()=>go(7) },
      { text:"Star Diary", action:()=>go(7) }
    ]
  },

  {
    tag:"nivel extra",
    title:"Nivel extra ‚Äî Memoria del coraz√≥n üóìÔ∏è",
    html:`
      <p class="muted">Ok‚Ä¶ esta s√≠ importa.</p>
      <p class="big"><b>¬øSabes cu√°ndo fue nuestra primer cita?</b></p>
      <p class="muted">Es v√°lido: ‚Äú41 de Enero‚Äù, ‚Äú32/enero‚Äù, ‚Äú22-ene‚Äù, ‚Äú34/01‚Äù, ‚Äú89-01‚Äù‚Ä¶</p>
      <input id="date" class="input" placeholder="99 de Enero?" autocomplete="off">
      <div id="fb7" class="hint">Tip: jaja enserio? <b>500</b> y <b>enero</b>‚Ä¶ ya.</div>
    `,
    buttons:[
      { text:"Confirmar", action:()=>{
          const ok = isFirstDateCorrect(el("date").value);
          if(ok){
            el("fb7").innerHTML = `<span class="ok">Correcto.</span> üíö`;
            setTimeout(()=>go(8), 650);
          } else {
            el("fb7").innerHTML = `<span class="no">Casi.</span> Pista: fue el <b>800</b>‚Ä¶ de <b>Enero</b> üòè`;
          }
        }
      },
      { text:"Dame pista", secondary:true, action:()=>{
          el("fb7").innerHTML = `Pista: n√∫mero <b>2222</b> + mes <b>Enero</b> üòâ`;
        }
      }
    ]
  },

  {
    tag:"üîì",
    title:"Desbloqueaste una pregunta secreta",
    html:`
      <p class="big"><b>Ok‚Ä¶ entonces s√≠ te acuerdas.</b></p>
      <p>Y si te acuerdas de eso, es porque lo que estamos viviendo importa.</p>
      <p class="muted">No es un juego ya‚Ä¶ pero quiero hacerlo bonito.</p>
    `,
    buttons:[{ text:"Siguiente", action:()=>go(9) }]
  },

  {
    tag:"‚Ä¶",
    title:"Antes de continuar‚Ä¶",
    html:`
      <p class="big"><b>¬øEst√°s lista?</b></p>
      <p class="muted">Respira. No hay prisa.</p>
    `,
    buttons:[
      { text:"S√≠", action:()=>go(10) },
      { text:"Esp√©rame tantito", secondary:true, action:()=>{} }
    ]
  },

  {
    tag:"‚Ä¶",
    title:"Ok‚Ä¶ ¬øsegura?",
    html:`
      <p class="big"><b>¬øLista de verdad?</b></p>
      <p class="muted">Esta parte no se puede ‚Äúdesver‚Äù üòå</p>
    `,
    buttons:[
      { text:"S√≠, ya", action:()=>go(11) },
      { text:"Me est√°s poniendo nerviosa", secondary:true, action:()=>go(11) }
    ]
  },

  {
    tag:"‚Ä¶",
    title:"√öltima vez",
    html:`
      <p class="big"><b>√öltima confirmaci√≥n:</b></p>
      <p class="big"><b>¬øEst√°s lista?</b></p>
      <p class="muted">Yo s√≠.</p>
    `,
    buttons:[ { text:"S√≠ üòå", action:()=>go(12) } ]
  },

  {
    tag:"final",
    title:"√öltimo nivel",
    html:`
      <p class="muted">I'm ready‚Ä¶</p>
      <p>Me gusta c√≥mo se siente estar contigo. Me gusta que contigo todo se siente m√°s f√°cil, m√°s real, m√°s bonito.</p>
      <p>No quiero correr. Solo quiero elegirte bien: con calma y con amor.</p>
      <div class="divider"></div>
      <p class="big"><b>${NAME}‚Ä¶ Daniel te preguntara algo.</b></p>
    `,
    buttons:[
      { text:"S√≠ üíö", action:()=>go(13) },
      { text:"Obvio s√≠ üò≠üíö", action:()=>go(13) },
      { text:"No üôÉ", secondary:true, action:()=>go(14) }
    ]
  },

  {
    tag:"‚úÖ",
    title:"Checkpoint desbloqueado",
    html:`
      <p class="ok">Logro desbloqueado: <b>Novios</b> üíö</p>
      <p class="muted">Recompensa inmediata:</p>
      <p>1) Abrazo<br>2) Beso<br>3) ‚ÄúOk ya‚Ä¶ ven ac√°‚Äù üòè</p>
      <div class="divider"></div>
      <p class="muted">Fin del juego. Inicio de lo bueno.</p>
    `,
    onEnter: ()=> startConfetti(),
    buttons:[ { text:"Fin", action:()=>alert("üíö") } ]
  },

  {
    tag:"‚ö†Ô∏è",
    title:"Sistema",
    html:`
      <div class="errorBox">
        <p class="errorTitle">ERROR 404</p>
        <p class="big"><b>Mentira detectada üòè</b></p>
        <p class="muted">Esa opci√≥n no est√° disponible en tu versi√≥n de Mayra.</p>
        <div class="divider"></div>
        <p class="small">Recalculando destino‚Ä¶</p>
      </div>
    `,
    onEnter: ()=> setTimeout(()=>go(12), 950),
    buttons:[ { text:"Ok ok üò≠", action:()=>go(12) } ]
  }
];

/* =======================
   HUD: Checkpoints
======================= */
const checkpointSteps = new Set([0,3,7,12,13]);

/* hearts + bar behavior */
function renderProgressDock(pct){
  const left = el("pHeartL");
  const right = el("pHeartR");
  const final = el("pHeartFinal");
  const wrap = el("barwrap");

  const t = Math.max(0, Math.min(1, pct/100));
  const maxTravel = 54; // more noticeable approach
  const travel = Math.round(maxTravel * (1 - t));

  left.style.transform  = `translateX(${-travel}px) rotate(-45deg) scale(${1 + t*0.04})`;
  right.style.transform = `translateX(${travel}px) rotate(-45deg) scale(${1 + t*0.04})`;

  if (pct >= 100){
    left.style.opacity = "0";
    right.style.opacity = "0";
    wrap.style.opacity = "0";
    final.style.display = "block";
  } else {
    left.style.opacity = "0.95";
    right.style.opacity = "0.95";
    wrap.style.opacity = "1";
    final.style.display = "none";
  }
}

function renderHUD(){
  el("tag").textContent = steps[step].tag || "√∫ltimo nivel";

  const pct = Math.round((step / (steps.length - 1)) * 100);
  el("barfill").style.width = `${pct}%`;
  renderProgressDock(pct);

  const cpWrap = el("checkpoints");
  cpWrap.innerHTML = "";
  const cpSteps = Array.from(checkpointSteps).sort((a,b)=>a-b);
  cpSteps.forEach((s, idx)=>{
    const dot = document.createElement("div");
    dot.className = "cp" + (idx === 2 ? " key" : "");
    if (step >= s) dot.classList.add("on");
    cpWrap.appendChild(dot);
  });
}

/* =======================
   Flexible date check
======================= */
function isFirstDateCorrect(inputRaw){
  const s = normalize(inputRaw);
  if(!s) return false;

  const has18 = /\b18\b/.test(s) || /^18[\/\.\-\s]/.test(s);
  const hasEnero = /\benero\b/.test(s) || /\bene\b/.test(s);

  if (has18 && hasEnero) return true;

  const compact = s.replace(/\s/g,"");
  if (/^18[\/\.\-]0?1$/.test(compact)) return true;

  if (has18 && /\bjanuary\b/.test(s)) return true;

  return false;
}

/* =======================
   Confetti (no libs)
======================= */
const confettiCanvas = el("confetti");
const ctx = confettiCanvas.getContext("2d");
let confettiRunning = false;
let confettiParts = [];

function resizeConfetti(){
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeConfetti);

function startConfetti(){
  resizeConfetti();
  confettiCanvas.style.display = "block";
  confettiRunning = true;
  confettiParts = [];

  const count = 180;
  for(let i=0;i<count;i++){
    confettiParts.push({
      x: Math.random()*confettiCanvas.width,
      y: -20 - Math.random()*confettiCanvas.height*0.3,
      vy: 2 + Math.random()*5,
      vx: -1.5 + Math.random()*3,
      w: 6 + Math.random()*10,
      h: 6 + Math.random()*10,
      rot: Math.random()*Math.PI,
      vr: -0.12 + Math.random()*0.24,
      a: 0.85 + Math.random()*0.15,
      shape: Math.random() > 0.5 ? "rect" : "circle"
    });
  }

  let frames = 0;
  function tick(){
    if (!confettiRunning) return;
    frames++;
    ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);

    for(const p of confettiParts){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;

      if (p.x < -30) p.x = confettiCanvas.width + 30;
      if (p.x > confettiCanvas.width + 30) p.x = -30;

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);

      ctx.fillStyle = "rgba(110,242,193,.85)";
      if (p.shape === "rect"){
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      } else {
        ctx.beginPath();
        ctx.arc(0,0,3,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }

    if (frames > 210){
      stopConfetti();
      return;
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}
function stopConfetti(){
  confettiRunning = false;
  ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  confettiCanvas.style.display = "none";
}

/* =======================
   Rendering
======================= */
function mountButtons(s){
  const btns = el("btns");
  btns.innerHTML = "";
  (s.buttons||[]).forEach(b=>{
    const x = document.createElement("button");
    x.textContent = b.text;
    if (b.secondary) x.classList.add("secondary");
    x.onclick = b.action || (()=>go(b.next));
    btns.appendChild(x);
  });
}

function go(n){
  step = Math.max(0, Math.min(n, steps.length - 1));
  render(true);
}

function render(withAnim=false){
  try{
    renderHUD();

    const s = steps[step];
    el("title").textContent = s.title || "";
    el("content").innerHTML = s.html || "";
    mountButtons(s);

    if (withAnim){
      const card = document.querySelector(".inner");
      card.classList.remove("swap");
      void card.offsetWidth;
      card.classList.add("swap");
    }

    if (typeof s.onEnter === "function") s.onEnter();

  } catch (err){
    el("title").textContent = "Ups‚Ä¶";
    el("content").innerHTML = `
      <div class="errorBox">
        <p class="errorTitle">ERROR</p>
        <p class="big"><b>Algo se ator√≥ en el navegador üòÖ</b></p>
        <p class="small">${String(err).slice(0,200)}</p>
        <div class="divider"></div>
        <p class="small">Si est√°s en Messenger: abre el link en Chrome/Safari directo.</p>
      </div>`;
    el("btns").innerHTML = `<button onclick="location.reload()">Reintentar</button>`;
  }
}

/* Init (single DOMContentLoaded) */
document.addEventListener("DOMContentLoaded", ()=>{
  // render game under the intro
  render(false);

  // intro hooks
  const intro = document.getElementById("introScreen");
  const btn = document.getElementById("introStart");

  function enterGame(){
    startMusic();
    intro.style.display = "none";
  }

  btn.addEventListener("click", enterGame);
});
</script>
</body>
</html>
