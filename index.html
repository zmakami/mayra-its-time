<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√öltimo Nivel</title>

  <style>
    :root{
      --ink:#e7fff4;
      --muted:#b7d9c9;
      --line:#0e2f25;
      --accent:#31c48d;
      --accent2:#6ef2c1;
      --warn:#ffb3b3;
      --card: rgba(255,255,255,.04);
    }
    *{ box-sizing:border-box; }

    body{
      margin:0; min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      display:flex; align-items:center; justify-content:center;
      padding:24px;
      overflow:hidden;
      background:#030a07;
    }

    /* Background video */
    #bgvideo{
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      min-width:100%;
      min-height:100%;
      width:auto; height:auto;
      z-index:-3;
      object-fit:cover;
      filter: blur(2px) brightness(.50) contrast(1.12);
      opacity:.20;
    }

    .overlay{
      position:fixed; inset:0;
      z-index:-2;
      background: radial-gradient(1200px 700px at 50% 35%,
        rgba(10,42,31,.55) 0%,
        rgba(6,17,13,.86) 55%,
        rgba(3,10,7,.93) 100%);
    }

    /* Confetti */
    #confetti{
      position:fixed; inset:0;
      z-index:5;
      pointer-events:none;
      display:none;
    }

    /* Card */
    .card{
      width:min(860px,100%);
      background: var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      padding:18px 18px 20px;
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 210px at 18% 10%, rgba(49,196,141,.18), transparent 60%),
        radial-gradient(640px 260px at 86% 12%, rgba(110,242,193,.14), transparent 62%),
        radial-gradient(700px 320px at 50% 102%, rgba(49,196,141,.10), transparent 60%);
      filter: blur(10px);
      opacity:.85;
      pointer-events:none;
      z-index:0;
    }
    .inner{ position:relative; z-index:1; }

    /* HUD */
    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; letter-spacing:.15em; text-transform:uppercase;
      color:var(--muted);
      gap:12px;
      margin-bottom:12px;
    }
    .leftpack{ display:flex; align-items:center; gap:10px; min-width:190px; }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 18px rgba(49,196,141,.55);
      display:inline-block;
    }

    .hud{
      display:flex; align-items:center; gap:12px;
      justify-content:flex-end;
      flex:1;
    }

    .checkpoints{ display:flex; gap:6px; align-items:center; }
    .cp{
      width:10px;height:10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      transition: transform .2s ease, background .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .cp.key{ width:12px;height:12px; }
    .cp.on{
      background: rgba(49,196,141,.55);
      border-color: rgba(49,196,141,.55);
      box-shadow:0 0 16px rgba(49,196,141,.35);
      transform: translateY(-1px);
    }

    .barwrap{
      width:min(360px, 48vw);
      height:10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .barfill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(49,196,141,.35), rgba(110,242,193,.55));
      box-shadow:0 0 18px rgba(49,196,141,.35);
      border-radius:999px;
      transition: width .35s ease;
    }
    .xp{
      font-size:11px;
      letter-spacing:.12em;
      color:var(--muted);
      white-space:nowrap;
    }
    .xp b{ color: var(--ink); letter-spacing:.08em; }

    /* Content */
    h1{ margin:0 0 10px; font-size:22px; letter-spacing:.2px; }
    p{ margin:10px 0; line-height:1.62; }
    .muted{ color:var(--muted); font-size:14px; }
    .divider{ height:1px; background: var(--line); margin:14px 0; }
    .big{ font-size:18px; }
    .ok{ color:#7CFCB2; font-weight:800; }
    .no{ color:var(--warn); font-weight:800; }

    .btns{ display:grid; gap:10px; margin-top:18px; }
    button{
      border:1px solid var(--line);
      background: rgba(49,196,141,.15);
      color:var(--ink);
      padding:14px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, box-shadow .2s ease;
    }
    button:hover{
      background: rgba(49,196,141,.25);
      box-shadow:0 0 18px rgba(49,196,141,.08);
    }
    button:active{ transform: translateY(1px); }
    button.secondary{ background: transparent; color:var(--muted); }
    button.secondary:hover{ background: rgba(255,255,255,.03); color:var(--ink); }

    .input{
      width:100%; padding:12px; margin-top:12px;
      border-radius:12px; border:1px solid var(--line);
      background: rgba(0,0,0,.20); color:var(--ink);
      outline:none;
      font-size:16px;
    }
    .hint{ margin-top:10px; font-size:13px; color:var(--muted); }

    /* SAFE animation: content is ALWAYS visible, animation is just a bonus */
    .swap{ animation: swapIn .28s ease both; }
    @keyframes swapIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* Error screen */
    .errorBox{
      border:1px solid rgba(255,179,179,.35);
      background: rgba(255,179,179,.06);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 0 22px rgba(255,179,179,.08);
    }
    .errorTitle{
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      margin:0 0 6px;
      color:var(--warn);
    }
    .small{ font-size:13px; color:var(--muted); }
  </style>
</head>

<body>

  <video id="bgvideo" autoplay muted loop playsinline preload="auto">
    <source src="video.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <canvas id="confetti"></canvas>

  <audio id="bgm" loop preload="auto">
    <source src="music.mp3" type="audio/mpeg">
  </audio>

  <div class="card" role="application" aria-label="√öltimo Nivel">
    <div class="inner">
      <div class="topbar">
        <div class="leftpack">
          <span class="dot"></span>
          <span id="tag">inicio</span>
        </div>

        <div class="hud">
          <div class="checkpoints" id="checkpoints"></div>
          <div class="barwrap"><div class="barfill" id="barfill"></div></div>
          <div class="xp" id="xp">XP <b>0</b></div>
        </div>
      </div>

      <h1 id="title">Cargando‚Ä¶</h1>
      <div id="content"></div>
      <div class="btns" id="btns"></div>
    </div>
  </div>

<script>
/* =======================
   CONFIG
======================= */
const NAME = "Mayra";

/* =======================
   MUSIC (fade-in)
======================= */
const bgm = document.getElementById("bgm");
let musicStarted = false;
function startMusic(){
  if (musicStarted) return;
  musicStarted = true;
  bgm.volume = 0;
  bgm.play().catch(()=>{});
  let v = 0;
  const fade = setInterval(()=>{
    v += 0.02;
    bgm.volume = Math.min(v, 0.26);
    if (v >= 0.26) clearInterval(fade);
  }, 120);
}

/* =======================
   HELPERS
======================= */
let step = 0;
let xp = 0;
const maxXP = 1000;

function el(id){ return document.getElementById(id); }
function normalize(s){
  return (s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^\w\s\/\.\-]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

/* =======================
   FLOW (STEPS)
======================= */
const steps = [
  {
    tag:"inicio",
    title:`Hola, ${NAME}. üíö`,
    html:`
      <p class="muted">Ok‚Ä¶ esto es algo chiquito, pero lo hice con intenci√≥n.</p>
      <p>Me gusta lo que estamos viviendo porque se siente f√°cil. No por ‚Äúsimple‚Äù, sino por real.</p>
      <p>As√≠ que te arm√© un juego r√°pido: bonito, inteligente, y muy nosotros. Sin presi√≥n.</p>
      <div class="divider"></div>
      <p class="muted">Reglas:</p>
      <p class="muted">1) No te saltes nada.<br>2) Si sonr√≠es, vas bien.<br>3) Si te pones nerviosa‚Ä¶ yo tambi√©n üòå</p>
    `,
    buttons:[{ text:"Empezar", action:()=>{ startMusic(); go(1); } }]
  },

  {
    tag:"pregunta 1/6",
    title:"Nivel 1 ‚Äî Se√±al clar√≠sima üòè",
    html:`
      <p>Empezamos suave, pero real.</p>
      <p class="big"><b>¬øCu√°l es la se√±al m√°s obvia de que me gustas?</b></p>
      <p class="muted">No te asustes: todas son verdad‚Ä¶ solo elige la que m√°s te d√© risa.</p>
    `,
    buttons:[
      { text:"Me importa tu d√≠a de verdad", action:()=>go(2) },
      { text:"Me dan ganas de verte aunque est√© cansado", action:()=>go(2) },
      { text:"Contigo me da paz (y eso no es com√∫n)", action:()=>go(2) }
    ]
  },

  {
    tag:"pregunta 2/6",
    title:"Nivel 2 ‚Äî Lectura fina üß†",
    html:`
      <p class="muted">Esta es de esas que dicen mucho sin decirlo.</p>
      <p class="big"><b>Cuando alguien te importa‚Ä¶ ¬øqu√© cambia?</b></p>
      <p>Elige la opci√≥n m√°s ‚Äúnosotros‚Äù:</p>
    `,
    buttons:[
      { text:"Dejas de fingir y te sientes t√∫", action:()=>go(3) },
      { text:"Todo se vuelve m√°s simple, pero m√°s bonito", action:()=>go(3) },
      { text:"Ya no buscas emoci√≥n‚Ä¶ buscas calma", action:()=>go(3) }
    ]
  },

  {
    tag:"pregunta 3/6",
    title:"Nivel 3 ‚Äî Completa la frase",
    html:`
      <p>Quiero una respuesta tuya, no de opci√≥n m√∫ltiple üòå</p>
      <p class="big"><b>Completa:</b> ‚ÄúSe siente ______ contigo.‚Äù</p>
      <p class="muted">Una o dos palabras. Lo primero que te salga.</p>
      <input id="a3" class="input" placeholder="Escr√≠belo aqu√≠‚Ä¶" autocomplete="off">
      <div id="fb3" class="hint">Tip: puede ser ‚Äúf√°cil‚Äù, ‚Äúbonito‚Äù, ‚Äúreal‚Äù, ‚Äúen paz‚Äù‚Ä¶</div>
    `,
    buttons:[
      { text:"Continuar", action:()=>{
          const v = normalize(el("a3").value);
          if(v.length >= 2) go(4);
          else el("fb3").innerHTML = `<span class="no">Pon algo chiquito pero real üòå</span>`;
        }
      },
      { text:"Dame idea", secondary:true, action:()=>{
          el("a3").value = "f√°cil y bonito";
          el("fb3").innerHTML = `<span class="ok">Esooo.</span> Ahora s√≠.`;
        }
      }
    ]
  },

  {
    tag:"pregunta 4/6",
    title:"Nivel 4 ‚Äî La respuesta adulta üíö",
    html:`
      <p class="muted">Rom√°ntica sin ser cursi.</p>
      <p class="big"><b>¬øQu√© te convence de algo bonito?</b></p>
      <p>Elige:</p>
    `,
    buttons:[
      { text:"Que se sienta natural, no forzado", action:()=>go(5) },
      { text:"Que haya intenci√≥n, no prisa", action:()=>go(5) },
      { text:"Que haya paz‚Ä¶ y ganas", action:()=>go(5) }
    ]
  },

  {
    tag:"pregunta 5/6",
    title:"Nivel 5 ‚Äî Trampa bonita üòè",
    html:`
      <p class="muted">Si te r√≠es aqu√≠, ya ganamos.</p>
      <p class="big"><b>Si yo pudiera pedir un ‚Äúpower-up‚Äù para lo nuestro, ser√≠a:</b></p>
      <p class="muted">Elige el que sienta m√°s t√∫.</p>
    `,
    buttons:[
      { text:"M√°s momentos simples que se sientan enormes", action:()=>go(6) },
      { text:"M√°s besos‚Ä¶ y menos miedo", action:()=>go(6) },
      { text:"M√°s t√∫ aqu√≠‚Ä¶ conmigo", action:()=>go(6) }
    ]
  },

  {
    tag:"pregunta 6/6",
    title:"Nivel 6 ‚Äî La m√°s real",
    html:`
      <p>√öltima de las ‚Äúnormales‚Äù.</p>
      <p class="big"><b>¬øCu√°l es la diferencia entre gustar y elegir?</b></p>
      <p class="muted">No hay respuesta perfecta‚Ä¶ pero s√≠ una que se siente verdadera.</p>
    `,
    buttons:[
      { text:"Gustar es emoci√≥n; elegir es intenci√≥n", action:()=>go(7) },
      { text:"Gustar es hoy; elegir es seguir ma√±ana", action:()=>go(7) },
      { text:"Gustar es f√°cil; elegir es cuidarlo", action:()=>go(7) }
    ]
  },

  {
    tag:"nivel extra",
    title:"Nivel extra ‚Äî Memoria del coraz√≥n üóìÔ∏è",
    html:`
      <p class="muted">Ok‚Ä¶ esta s√≠ importa.</p>
      <p class="big"><b>¬øSabes cu√°ndo fue nuestra primer cita?</b></p>
      <p class="muted">Es v√°lido: ‚Äú18 de Enero‚Äù, ‚Äú18/enero‚Äù, ‚Äú18-ene‚Äù, ‚Äú18/01‚Äù, ‚Äú18-01‚Äù‚Ä¶</p>
      <input id="date" class="input" placeholder="18 de Enero" autocomplete="off">
      <div id="fb7" class="hint">Tip: con que salga <b>18</b> y <b>enero</b>‚Ä¶ ya.</div>
    `,
    buttons:[
      { text:"Confirmar", action:()=>{
          const ok = isFirstDateCorrect(el("date").value);
          if(ok){
            el("fb7").innerHTML = `<span class="ok">Correcto.</span> üíö`;
            setTimeout(()=>go(8), 650);
          } else {
            el("fb7").innerHTML = `<span class="no">Casi.</span> Pista: fue el <b>18</b>‚Ä¶ de <b>Enero</b> üòè`;
          }
        }
      },
      { text:"Dame pista", secondary:true, action:()=>{
          el("fb7").innerHTML = `Pista: n√∫mero <b>18</b> + mes <b>Enero</b> üòâ`;
        }
      }
    ]
  },

  {
    tag:"üîì",
    title:"Desbloqueaste una pregunta secreta",
    html:`
      <p class="big"><b>Ok‚Ä¶ entonces s√≠ te acuerdas.</b></p>
      <p>Y si te acuerdas de eso, es porque lo que estamos viviendo importa.</p>
      <p class="muted">No es un juego ya‚Ä¶ pero quiero hacerlo bonito.</p>
    `,
    buttons:[{ text:"Siguiente", action:()=>go(9) }]
  },

  {
    tag:"‚Ä¶",
    title:"Antes de continuar‚Ä¶",
    html:`
      <p class="big"><b>¬øEst√°s lista?</b></p>
      <p class="muted">Respira. No hay prisa.</p>
    `,
    buttons:[
      { text:"S√≠", action:()=>go(10) },
      { text:"Esp√©rame tantito", secondary:true, action:()=>{} }
    ]
  },

  {
    tag:"‚Ä¶",
    title:"Ok‚Ä¶ ¬øsegura?",
    html:`
      <p class="big"><b>¬øLista de verdad?</b></p>
      <p class="muted">Esta parte no se puede ‚Äúdesver‚Äù üòå</p>
    `,
    buttons:[
      { text:"S√≠, ya", action:()=>go(11) },
      { text:"Me est√°s poniendo nerviosa", secondary:true, action:()=>go(11) }
    ]
  },

  {
    tag:"‚Ä¶",
    title:"√öltima vez",
    html:`
      <p class="big"><b>√öltima confirmaci√≥n:</b></p>
      <p class="big"><b>¬øEst√°s lista?</b></p>
      <p class="muted">Yo s√≠.</p>
    `,
    buttons:[ { text:"S√≠ üòå", action:()=>go(12) } ]
  },

  {
    tag:"final",
    title:"√öltimo nivel",
    html:`
      <p class="muted">Ya fuera de juego‚Ä¶</p>
      <p>Me gusta c√≥mo se siente estar contigo. Me gusta que contigo todo se siente m√°s f√°cil, m√°s real, m√°s bonito.</p>
      <p>No quiero correr. Solo quiero elegirte bien: con calma y con intenci√≥n.</p>
      <div class="divider"></div>
      <p class="big"><b>${NAME}‚Ä¶ ¬øquieres ser mi novia?</b></p>
    `,
    buttons:[
      { text:"S√≠ üíö", action:()=>go(13) },
      { text:"Obvio s√≠ üò≠üíö", action:()=>go(13) },
      { text:"No üôÉ", secondary:true, action:()=>go(14) }
    ]
  },

  {
    tag:"‚úÖ",
    title:"Checkpoint desbloqueado",
    html:`
      <p class="ok">Logro desbloqueado: <b>Novios</b> üíö</p>
      <p class="muted">Recompensa inmediata:</p>
      <p>1) Abrazo<br>2) Beso<br>3) ‚ÄúOk ya‚Ä¶ ven ac√°‚Äù üòè</p>
      <div class="divider"></div>
      <p class="muted">Fin del juego. Inicio de lo bueno.</p>
    `,
    onEnter: ()=> startConfetti(),
    buttons:[ { text:"Fin", action:()=>alert("üíö") } ]
  },

  {
    tag:"‚ö†Ô∏è",
    title:"Sistema",
    html:`
      <div class="errorBox">
        <p class="errorTitle">ERROR 404</p>
        <p class="big"><b>Mentira detectada üòè</b></p>
        <p class="muted">Esa opci√≥n no est√° disponible en tu versi√≥n de Mayra.</p>
        <div class="divider"></div>
        <p class="small">Recalculando destino‚Ä¶</p>
      </div>
    `,
    onEnter: ()=> setTimeout(()=>go(12), 950),
    buttons:[ { text:"Ok ok üò≠", action:()=>go(12) } ]
  }
];

/* =======================
   HUD: Progress + XP + Checkpoints
======================= */
const checkpointSteps = new Set([0,3,7,12,13]); // intro, frase, fecha, propuesta, novios

function stepToXP(n){
  const t = n / (steps.length - 1);
  const eased = t*t*(3 - 2*t); // smoothstep
  return Math.round(eased * maxXP);
}

function renderHUD(){
  el("tag").textContent = steps[step].tag || "√∫ltimo nivel";

  const pct = Math.round((step / (steps.length - 1)) * 100);
  el("barfill").style.width = `${pct}%`;

  xp = Math.max(xp, stepToXP(step));
  el("xp").innerHTML = `XP <b>${xp}</b>`;

  const cpWrap = el("checkpoints");
  cpWrap.innerHTML = "";
  const cpSteps = Array.from(checkpointSteps).sort((a,b)=>a-b);
  cpSteps.forEach((s, idx)=>{
    const dot = document.createElement("div");
    dot.className = "cp" + (idx === 2 ? " key" : "");
    if (step >= s) dot.classList.add("on");
    cpWrap.appendChild(dot);
  });
}

/* =======================
   Flexible date check
======================= */
function isFirstDateCorrect(inputRaw){
  const s = normalize(inputRaw);
  if(!s) return false;

  const has18 = /\b18\b/.test(s) || /^18[\/\.\-\s]/.test(s);
  const hasEnero = /\benero\b/.test(s) || /\bene\b/.test(s);

  if (has18 && hasEnero) return true;

  // numeric 18/01, 18-01, 18.01, 18/1
  const compact = s.replace(/\s/g,"");
  if (/^18[\/\.\-]0?1$/.test(compact)) return true;

  // english fallback
  if (has18 && /\bjanuary\b/.test(s)) return true;

  return false;
}

/* =======================
   Confetti (no libs)
======================= */
const confettiCanvas = el("confetti");
const ctx = confettiCanvas.getContext("2d");
let confettiRunning = false;
let confettiParts = [];

function resizeConfetti(){
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeConfetti);

function startConfetti(){
  resizeConfetti();
  confettiCanvas.style.display = "block";
  confettiRunning = true;
  confettiParts = [];

  const count = 180;
  for(let i=0;i<count;i++){
    confettiParts.push({
      x: Math.random()*confettiCanvas.width,
      y: -20 - Math.random()*confettiCanvas.height*0.3,
      vy: 2 + Math.random()*5,
      vx: -1.5 + Math.random()*3,
      w: 6 + Math.random()*10,
      h: 6 + Math.random()*10,
      rot: Math.random()*Math.PI,
      vr: -0.12 + Math.random()*0.24,
      a: 0.85 + Math.random()*0.15,
      shape: Math.random() > 0.5 ? "rect" : "circle"
    });
  }

  let frames = 0;
  function tick(){
    if (!confettiRunning) return;
    frames++;
    ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);

    for(const p of confettiParts){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;

      if (p.x < -30) p.x = confettiCanvas.width + 30;
      if (p.x > confettiCanvas.width + 30) p.x = -30;

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);

      // confetti menta (brand)
      ctx.fillStyle = "rgba(110,242,193,.85)";
      if (p.shape === "rect"){
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      } else {
        ctx.beginPath();
        ctx.arc(0,0,3,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }

    if (frames > 210){
      stopConfetti();
      return;
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}
function stopConfetti(){
  confettiRunning = false;
  ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  confettiCanvas.style.display = "none";
}

/* =======================
   Rendering
======================= */
function mountButtons(s){
  const btns = el("btns");
  btns.innerHTML = "";
  (s.buttons||[]).forEach(b=>{
    const x = document.createElement("button");
    x.textContent = b.text;
    if (b.secondary) x.classList.add("secondary");
    x.onclick = b.action || (()=>go(b.next));
    btns.appendChild(x);
  });
}

function go(n){
  step = Math.max(0, Math.min(n, steps.length - 1));
  render(true);
}

function render(withAnim=false){
  try{
    renderHUD();

    const s = steps[step];
    el("title").textContent = s.title || "";
    el("content").innerHTML = s.html || "";
    mountButtons(s);

    // safe animation
    if (withAnim){
      const card = document.querySelector(".inner");
      card.classList.remove("swap");
      void card.offsetWidth;
      card.classList.add("swap");
    }

    if (typeof s.onEnter === "function") s.onEnter();

  } catch (err){
    el("title").textContent = "Ups‚Ä¶";
    el("content").innerHTML = `
      <div class="errorBox">
        <p class="errorTitle">ERROR</p>
        <p class="big"><b>Algo se ator√≥ en el navegador üòÖ</b></p>
        <p class="small">${String(err).slice(0,200)}</p>
        <div class="divider"></div>
        <p class="small">Si est√°s en Messenger: abre el link en Chrome/Safari directo.</p>
      </div>`;
    el("btns").innerHTML = `<button onclick="location.reload()">Reintentar</button>`;
  }
}

/* Init */
document.addEventListener("DOMContentLoaded", ()=> render(false));
</script>
</body>
</html>
