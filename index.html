<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√öltimo Nivel</title>

  <style>
    :root{
      --bg:#06110d;
      --ink:#e7fff4;
      --muted:#b7d9c9;
      --line:#0e2f25;
      --accent:#31c48d;
      --accent2:#6ef2c1;
      --warn:#ffb3b3;
      --card: rgba(255,255,255,.035);
    }
    *{box-sizing:border-box}

    body{
      margin:0; min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      display:flex; align-items:center; justify-content:center;
      padding:24px;
      overflow:hidden;
      background:#030a07;
    }

    /* ====== VIDEO BACKGROUND (local) ====== */
    #bgvideo{
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      min-width:100%;
      min-height:100%;
      width:auto;
      height:auto;
      z-index:-3;
      object-fit:cover;
      filter: blur(2px) brightness(.50) contrast(1.12);
      opacity:.20; /* sutil */
    }

    /* capa para mantener el mood verde oscuro y legibilidad */
    .overlay{
      position:fixed; inset:0;
      z-index:-2;
      background: radial-gradient(1200px 700px at 50% 35%,
        rgba(10,42,31,.55) 0%,
        rgba(6,17,13,.86) 55%,
        rgba(3,10,7,.93) 100%);
    }

    /* ====== CONFETTI CANVAS ====== */
    #confetti{
      position:fixed; inset:0;
      z-index:3;
      pointer-events:none;
      display:none;
    }

    /* ====== CARD ====== */
    .card{
      width:min(820px,100%);
      background: var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      padding:18px 18px 20px;
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);

      /* micro glow fino */
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(500px 200px at 20% 10%, rgba(49,196,141,.18), transparent 60%),
        radial-gradient(600px 240px at 85% 15%, rgba(110,242,193,.14), transparent 62%),
        radial-gradient(600px 300px at 50% 100%, rgba(49,196,141,.10), transparent 60%);
      pointer-events:none;
      filter: blur(10px);
      opacity:.85;
    }

    .inner{
      position:relative;
      z-index:1;
    }

    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; letter-spacing:.15em; text-transform:uppercase;
      color:var(--muted); margin-bottom:10px;
      gap:12px;
    }

    .leftpack{
      display:flex; align-items:center; gap:10px;
      min-width:200px;
    }

    .dot{
      width:8px;height:8px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 18px rgba(49,196,141,.55);
      display:inline-block;
    }

    /* ====== PROGRESS + XP ====== */
    .hud{
      display:flex; align-items:center; gap:12px;
      justify-content:flex-end;
      flex:1;
    }

    .barwrap{
      width:min(360px, 48vw);
      height:10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
    }
    .barfill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(49,196,141,.35), rgba(110,242,193,.55));
      box-shadow:0 0 18px rgba(49,196,141,.35);
      border-radius:999px;
      transition: width .35s ease;
    }
    .xp{
      font-size:11px;
      letter-spacing:.12em;
      color:var(--muted);
      white-space:nowrap;
    }
    .xp b{ color: var(--ink); letter-spacing:.08em; }

    /* checkpoints */
    .checkpoints{
      display:flex; gap:6px; align-items:center;
    }
    .cp{
      width:10px;height:10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      box-shadow:none;
      transition: transform .2s ease, background .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .cp.on{
      background: rgba(49,196,141,.55);
      border-color: rgba(49,196,141,.55);
      box-shadow:0 0 16px rgba(49,196,141,.35);
      transform: translateY(-1px);
    }
    .cp.key{
      width:12px;height:12px;
    }

    h1{margin:0 0 10px;font-size:22px; letter-spacing:.2px}
    p{margin:10px 0;line-height:1.62}
    .muted{color:var(--muted);font-size:14px}
    .btns{display:grid;gap:10px;margin-top:18px}
    button{
      border:1px solid var(--line);
      background: rgba(49,196,141,.15);
      color:var(--ink);
      padding:14px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, box-shadow .2s ease;
    }
    button:hover{
      background: rgba(49,196,141,.25);
      box-shadow:0 0 18px rgba(49,196,141,.08);
    }
    button:active{transform: translateY(1px)}
    button.secondary{ background: transparent; color:var(--muted); }
    button.secondary:hover{background: rgba(255,255,255,.03); color:var(--ink)}

    .input{
      width:100%;padding:12px;margin-top:12px;
      border-radius:12px;border:1px solid var(--line);
      background: rgba(0,0,0,.20);color:var(--ink);
      outline:none;
      font-size:16px;
    }
    .hint{margin-top:10px;font-size:13px;color:var(--muted)}
    .ok{color:#7CFCB2;font-weight:800}
    .no{color:var(--warn);font-weight:800}
    .divider{height:1px; background: var(--line); margin:14px 0}
    .big{font-size:18px}

    /* ====== TRANSITION ====== */
    .stage{
      opacity:0;
      transform: translateY(10px);
      filter: blur(0px);
      transition: opacity .28s ease, transform .28s ease;
      will-change: opacity, transform;
    }
    .stage.in{
      opacity:1;
      transform: translateY(0);
    }

    /* ====== GLITCH / ERROR SCREEN ====== */
    .errorBox{
      border:1px solid rgba(255,179,179,.35);
      background: rgba(255,179,179,.06);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 0 22px rgba(255,179,179,.08);
    }
    .errorTitle{
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      margin:0 0 6px;
      color:var(--warn);
    }
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>

<body>

<!-- üåå Background video -->
<video id="bgvideo" autoplay muted loop playsinline preload="auto">
  <source src="video.mp4" type="video/mp4">
</video>
<div class="overlay"></div>

<canvas id="confetti"></canvas>

<!-- üéµ Music (your file) -->
<audio id="bgm" loop preload="auto">
  <source src="music.mp3" type="audio/mpeg">
</audio>

<div class="card" role="application" aria-label="√öltimo Nivel">
  <div class="inner">
    <div class="topbar">
      <div class="leftpack">
        <span class="dot"></span>
        <span id="tag">inicio</span>
      </div>

      <div class="hud">
        <div class="checkpoints" id="checkpoints" aria-label="Checkpoints"></div>
        <div class="barwrap" aria-label="Progreso">
          <div class="barfill" id="barfill"></div>
        </div>
        <div class="xp" id="xp">XP <b>0</b></div>
      </div>
    </div>

    <h1 id="title"></h1>

    <!-- stage wrapper for animation -->
    <div id="stage" class="stage">
      <div id="content"></div>
      <div class="btns" id="btns"></div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const NAME = "Mayra";

/* ===== MUSIC CONTROL (fade-in) ===== */
const bgm = document.getElementById("bgm");
let musicStarted = false;
function startMusic(){
  if (musicStarted) return;
  musicStarted = true;
  bgm.volume = 0;
  bgm.play().catch(()=>{});
  let v = 0;
  const fade = setInterval(()=>{
    v += 0.02;
    bgm.volume = Math.min(v, 0.26);
    if (v >= 0.26) clearInterval(fade);
  }, 120);
}

/* ===== HELPERS ===== */
let step = 0;
let xp = 0;
function el(id){ return document.getElementById(id); }
function go(n){
  step = Math.max(0, Math.min(n, steps.length-1));
  render(true);
}
function normalize(s){
  return (s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^\w\s\/\.\-]/g," ") // deja / . - para fechas
    .replace(/\s+/g," ")
    .trim();
}

/* ===== PROGRESS/XP/CHECKPOINTS ===== */
const totalSteps = () => steps.length;
const maxXP = 1000;

function stepToXP(n){
  // XP no lineal: al principio sube suave, al final sube m√°s (m√°s ‚Äúgamer‚Äù)
  const t = (n) / (totalSteps()-1);
  const eased = t*t*(3 - 2*t); // smoothstep
  return Math.round(eased * maxXP);
}

const checkpointSteps = new Set([
  0, 3, 7, 12, 13 // intro, frase, fecha, propuesta, novios
]);

function renderHUD(){
  // tag
  el("tag").textContent = steps[step].tag || "√∫ltimo nivel";

  // progress bar (real %)
  const pct = Math.round((step / (totalSteps()-1)) * 100);
  el("barfill").style.width = `${pct}%`;

  // XP
  xp = Math.max(xp, stepToXP(step));
  el("xp").innerHTML = `XP <b>${xp}</b>`;

  // checkpoints UI
  const cpWrap = el("checkpoints");
  cpWrap.innerHTML = "";
  const cpSteps = Array.from(checkpointSteps).sort((a,b)=>a-b);

  cpSteps.forEach((s, idx)=>{
    const dot = document.createElement("div");
    dot.className = "cp" + (idx === 2 ? " key" : ""); // uno ‚Äúkey‚Äù al medio
    if (step >= s) dot.classList.add("on");
    dot.title = `Checkpoint ${idx+1}`;
    cpWrap.appendChild(dot);
  });
}

/* ===== DATE PARSING (flexible) ===== */
function isFirstDateCorrect(inputRaw){
  const s0 = normalize(inputRaw);

  if(!s0) return false;

  // 1) variants like: "18 de enero", "18 enero", "18 ene", "18/enero", "18-ene", "18.ene"
  const has18 = /\b18\b/.test(s0) || /^18[\/\.\- ]/.test(s0);
  const hasEnero = /\benero\b/.test(s0) || /\bene\b/.test(s0);

  if (has18 && hasEnero) return true;

  // 2) numeric formats like: 18/01, 18-01, 18.01, 18/1
  // also allow 01/18? (but better keep strict to avoid confusion)
  const num = s0.replace(/\s/g,"");
  if (/^18[\/\.\-]0?1$/.test(num)) return true;

  // 3) english fallback
  if ((/\b18\b/.test(s0) || /^18[\/\.\- ]/.test(s0)) && /\bjanuary\b/.test(s0)) return true;

  return false;
}

/* ===== CONFETTI ===== */
const confettiCanvas = el("confetti");
const ctx = confettiCanvas.getContext("2d");
let confettiRunning = false;
let confettiParts = [];

function resizeConfetti(){
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeConfetti);

function startConfetti(){
  resizeConfetti();
  confettiCanvas.style.display = "block";
  confettiRunning = true;
  confettiParts = [];

  const count = 180;
  for(let i=0;i<count;i++){
    confettiParts.push({
      x: Math.random()*confettiCanvas.width,
      y: -20 - Math.random()*confettiCanvas.height*0.3,
      r: 2 + Math.random()*4,
      vy: 2 + Math.random()*5,
      vx: -1.5 + Math.random()*3,
      w: 6 + Math.random()*10,
      h: 6 + Math.random()*10,
      rot: Math.random()*Math.PI,
      vr: -0.12 + Math.random()*0.24,
      a: 0.9 + Math.random()*0.1,
      shape: Math.random() > 0.5 ? "rect" : "circle"
    });
  }

  let frames = 0;
  function tick(){
    if (!confettiRunning) return;
    frames++;

    ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);

    for(const p of confettiParts){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;

      // wrap
      if (p.x < -30) p.x = confettiCanvas.width + 30;
      if (p.x > confettiCanvas.width + 30) p.x = -30;

      // draw (no fixed colors: use accent range via alpha only)
      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);

      // draw using current fillStyle (default) but randomize brightness via alpha
      ctx.fillStyle = "rgba(231,255,244,.8)"; // ink-ish (stays on brand)
      if (p.shape === "rect"){
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      } else {
        ctx.beginPath();
        ctx.arc(0,0,p.r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }

    // auto stop after ~3.5s
    if (frames > 210){
      stopConfetti();
      return;
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}
function stopConfetti(){
  confettiRunning = false;
  ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  confettiCanvas.style.display = "none";
}

/* ===== FLOW ===== */
const steps = [
/* 0 INTRO */
{
  tag:"inicio",
  title:`Hola, ${NAME}. üíö`,
  html:`
    <p class="muted">Ok‚Ä¶ esto es algo chiquito, pero lo hice con intenci√≥n.</p>
    <p>Me gusta lo que estamos viviendo porque se siente f√°cil. No por ‚Äúsimple‚Äù, sino por real.</p>
    <p>As√≠ que te arm√© un juego r√°pido: bonito, inteligente, y muy nosotros. Sin presi√≥n.</p>
    <div class="divider"></div>
    <p class="muted">Reglas:</p>
    <p class="muted">1) No te saltes nada.<br>2) Si sonr√≠es, vas bien.<br>3) Si te pones nerviosa‚Ä¶ yo tambi√©n üòå</p>
  `,
  buttons:[{
    text:"Empezar",
    action:()=>{ startMusic(); go(1); }
  }]
},

/* 1 Q1 */
{
  tag:"pregunta 1/6",
  title:"Nivel 1 ‚Äî Se√±al clar√≠sima üòè",
  html:`
    <p>Empezamos suave, pero real.</p>
    <p class="big"><b>¬øCu√°l es la se√±al m√°s obvia de que me gustas?</b></p>
    <p class="muted">No te asustes: todas son verdad‚Ä¶ solo elige la que m√°s te d√© risa.</p>
  `,
  buttons:[
    {
